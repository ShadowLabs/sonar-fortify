<h2>ABSTRACT</h2>
<p>
  Constructing a dynamic XQuery expression with user input could allow an attacker to modify the statement's meaning. 
</p>
<h2>EXPLANATION</h2>
<p>
  XQuery injection occurs when:<br /><br />1.      Data enters a program from an untrusted source.<br /><br /><p><br />In this case the data enters at <Replace key="SourceFunction" link="SourceLocation"/> in <Replace key="SourceLocation.file"/> at line <Replace key="SourceLocation.line"/>.<br /></p><br /><IfDef var="ConditionalDescriptions"><br /> <p><br />  <ConditionalText condition="taint:number"><br />Even though the data in this case is a number, it is unvalidated and thus still considered malicious, hence the vulnerability is still reported but with reduced priority values.<br />  </ConditionalText><br /> </p><br /></IfDef><br /><br />2.      The data used to dynamically construct an XQuery expression.<br /><br /><p><br />In this case the query is passed to <Replace key="SinkFunction" link="SinkLocation"/> in <Replace key="SinkLocation.file"/> at line <Replace key="SinkLocation.line"/>.<br /></p><br /><br /><b>Example 1:</b> The following code dynamically constructs and executes an XQuery expression that retrieves an user for a given username and password combination. The username and password are read from an HTTP request, and is therefore untrusted.<br /><br /><pre><br />...<br /><?php<br /><br />require_once 'zorba_api.php';<br /><br />$memstor = InMemoryStore::getInstance();<br />$z = Zorba::getInstance($memstor);<br /><br />try {<br />  // get data manager<br />  $dataman = $z-&gt;getXmlDataManager();<br /><br />  // load external XML document<br />  $dataman->loadDocument('users.xml', file_get_contents('users.xml'));<br /><br />  // create and compile query<br />  $express = <br />"for \$user in doc(users.xml)//user[username='" . $_GET["username"] . "'and password='" . $_GET["password"] . "'] return \$user"<br /><br />  $query = $zorba-&gt;compileQuery($express);<br /><br />  // execute query<br />  $result = $query-&gt;execute();<br /><br />?><br />...<br /></pre><br /><br />Under normal conditions, such as searching for an user with the appropriate username and password, the expression that this code executes will look like the following:<br /><br /><code>for \$user in doc(users.xml)//user[username='test_user' and password='pass123'] return \$user</code><br /><br />However, because the expression is constructed dynamically by concatenating a constant base query string and a user input string, the query only behaves correctly if <code>username</code> or <code>password</code> does not contain a single-quote character. If an attacker enters the string <code>admin' or 1=1 or ''='</code> for <code>username</code>, then the query becomes the following:<br /><br /><code>for \$user in doc(users.xml)//user[username='admin' or 1=1 or ''='' and password='x' or ''=''] return \$user</code><br /><br />The addition of the <code>admin' or 1=1 or ''='</code> condition causes the XQuery expression to always evaluate to true, so the query becomes logically equivalent to the much simpler query:<br /><br /><code>//user[username='admin']</code><br /><br />This simplification of the query allows the attacker to bypass the requirement that the query match the password; the query now returns the admin user stored in the document, regardless of the entered password.
</p>
<h2>REFERENCES</h2>
<p>
  
</p>