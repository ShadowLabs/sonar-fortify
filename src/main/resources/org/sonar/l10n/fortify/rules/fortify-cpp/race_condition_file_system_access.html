<h2>ABSTRACT</h2>
<p>
  The window of time between when a file property is checked and when the file is used can be exploited to launch a privilege escalation attack.
</p>
<h2>EXPLANATION</h2>
<p>
  File access race conditions, known as time-of-check, time-of-use (TOCTOU) race conditions, occur when:<br /><br />1. The program checks a property of a file, referencing the file by name. <br /><p><br />In this case the check is performed at <Replace key="FirstTransitionFunction" link="FirstTraceLocation"/> in <Replace key="FirstTraceLocation.file"/> at line <Replace key="FirstTraceLocation.line"/>. <br /></p><br />2. The program later performs a filesystem operation using the same filename and assumes that the previously-checked property still holds.<br /><p><br />The file is then used at <Replace key="PrimaryTransitionFunction" link="PrimaryLocation"/> in <Replace key="PrimaryLocation.file"/> at line <Replace key="PrimaryLocation.line"/>.<br /></p><br /><br /><b>Example 1:</b> The following code is from a program installed <code>setuid root</code>. The program performs certain file operations on behalf of non-privileged users, and uses access checks to ensure that it does not use its root privileges to perform operations that should otherwise be unavailable the current user. The program uses the <code>access()</code> system call to check if the person running the program has permission to access the specified file before it opens the file and performs the necessary operations. <br /><br /><pre><br />  if (!access(file,W_OK)) {<br />    f = fopen(file,"w+");<br />    operate(f);<br />    ...<br />  }<br />  else {<br />    fprintf(stderr,"Unable to open file %s.\n",file);<br />  }<br /></pre><br /><br />The call to <code>access()</code> behaves as expected, and returns <code>0</code> if the user running the program has the necessary permissions to write to the file, and -1 otherwise. However, because both <code>access()</code> and <code>fopen()</code> operate on filenames rather than on file handles, there is no guarantee that the <code>file</code> variable still refers to the same file on disk when it is passed to <code>fopen()</code> that it did when it was passed to <code>access()</code>. If an attacker replaces <code>file</code> after the call to <code>access()</code> with a symbolic link to a different file, the program will use its root privileges to operate on the file even if it is a file that the attacker would otherwise be unable to modify. By tricking the program into performing an operation that would otherwise be impermissible, the attacker has gained elevated privileges. <br /><br />This type of vulnerability is not limited to programs with <code>root</code> privileges. If the application is capable of performing any operation that the attacker would not otherwise be allowed perform, then it is a possible target.<br /><br />The window of vulnerability for such an attack is the period of time between when the property is tested and when the file is used. Even if the use immediately follows the check, modern operating systems offer no guarantee about the amount of code that will be executed before the process yields the CPU. Attackers have a variety of techniques for expanding the length of the window of opportunity in order to make exploits easier, but even with a small window, an exploit attempt can simply be repeated over and over until it is successful.<br /><br /><b>Example 2:</b> The following code creates a file and then changes the owner of the file.<br /><br /><pre><br />    fd = creat(FILE, 0644);  /* Create file */<br />    if (fd == -1)<br />        return;<br />    if (chown(FILE, UID, -1) &lt; 0) {  /* Change file owner */<br />      ...<br />    }<br /></pre><br /><br />The code assumes that the file operated upon by the call to <code>chown()</code> is the same as the file created by the call to <code>creat()</code>, but that is not necessarily the case.  Because <code>chown()</code> operates on a file name and not on a file handle, an attacker might be able to replace the file with a link to file the attacker does not own.  The call to <code>chown()</code> would then give the attacker ownership of the linked file.
</p>
<h2>REFERENCES</h2>
<p>
  
</p>