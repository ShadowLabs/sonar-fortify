<h2>ABSTRACT</h2>
<p>
  Processing an unvalidated XSL stylesheet can allow an attacker to change the structure and contents of the resultant XML, include arbitrary files from the file system, or execute arbitrary PHP code.
</p>
<h2>EXPLANATION</h2>
<p>
  XSLT injection occurs when:<br /><br />1. Data enters a program from an untrusted source.<br /><p><br />In this case the data enters at <Replace key="SourceFunction" link="SourceLocation"/> in <Replace key="SourceLocation.file"/> at line <Replace key="SourceLocation.line"/>.<br /></p><br /><IfDef var="ConditionalDescriptions"><br /> <p><br />  <ConditionalText condition="taint:number"><br />Even though the data in this case is a number, it is unvalidated and thus still considered malicious, hence the vulnerability is still reported but with reduced priority values.<br />  </ConditionalText><br /> </p><br /></IfDef><br /><br />2. The data is written to an XSL stylesheet. <br /><p><br />In this case the XSL is written by <Replace key="SinkFunction" link="SinkLocation"/> in <Replace key="SinkLocation.file"/> at line <Replace key="SinkLocation.line"/>.<br /></p><br /><br />Applications typically use XSL stylesheet to transform XML documents from one format to another.  XSL stylesheets include special functions which enhance the transformation process but introduce additional vulnerabilities if used incorrectly.<br /><br />The semantics of XSL stylesheets and processing can be altered if an attacker has the ability to write XSL elements in a stylesheet. An attacker could alter the output of a stylesheet such that a XSS (cross-site scripting) attack was enabled, expose the contents of local file system resources, or execute arbitrary PHP commands.  If the attacker had complete control over the stylesheet submitted to the application, then the attacker could also execute an XXE (Xml eXternal Entity) injection attack.<br /><br /><b>Example 1:</b> Here is some code that is vulnerable to XSLT Injection:<br /><br /><pre><br />...<br />&lt;?php<br /><br />$xml = new DOMDocument;<br />$xml-&gt;load('local.xml');<br /><br />$xsl = new DOMDocument;<br />$xsl-&gt;load($_GET['key']);<br /><br />$processor = new XSLTProcessor;<br />$processor-&gt;registerPHPFunctions();<br />$processor-&gt;importStyleSheet($xsl);<br /><br />echo $processor-&gt;transformToXML($xml);<br /><br />?&gt;<br />...<br /></pre><br /><br />The code above results in three different exploits when the attacker can pass the identified XSL to the XSTL processor:<br /><br />1.  XSS:<br /><br /><pre><br /><br />&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl"&gt;<br />&lt;xsl:template match="/"&gt;<br />&lt;script&gt;alert(123)&lt;/script&gt;<br />&lt;/xsl:template&gt;<br />&lt;/xsl:stylesheet&gt;<br /><br /></pre><br /><br />When the XSL stylesheet is processed, the &lt;script&gt; tag is rendered to the victim's browser allowing a cross-site scripting attack to be performed.<br /><br />2.  Reading of arbitrary files on the server's file system:<br /><br /><pre><br /><br />&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl"&gt;<br />&lt;xsl:template match="/"&gt;<br />&lt;xsl:copy-of select="document('/etc/passwd')"/&gt;<br />&lt;/xsl:template&gt;<br />&lt;/xsl:stylesheet&gt;<br /><br /></pre><br /><br />The above XSL stylesheet will return the contents of the /etc/passwd file.<br /><br />3.  Execution of arbitrary PHP code:<br /><br />The XSLT processor has the ability to expose native PHP language methods as XSLT functions by enabling "registerPHPFunctions".  <br /><br /><pre><br /><br />&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl"&gt;<br />&lt;xsl:template match="/"&gt;<br />&lt;xsl:value-of select="php:function('passthru','ls -la')"/&gt;<br />&lt;/xsl:template&gt;<br />&lt;/xsl:stylesheet&gt;<br /><br /></pre><br /><br />The above stylesheet will output the results of the "ls" command run on the server.
</p>
<h2>REFERENCES</h2>
<p>
  
</p>