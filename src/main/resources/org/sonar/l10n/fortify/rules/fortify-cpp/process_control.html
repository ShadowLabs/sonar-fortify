<h2>ABSTRACT</h2>
<p>
  Loading libraries from an untrusted source or in an untrusted environment can cause an application to execute malicious code on behalf of an attacker. 
</p>
<h2>EXPLANATION</h2>
<p>
  Process control vulnerabilities take two forms:<br /><br />- An attacker can change the library that the program executes: the attacker explicitly controls what the name of the library is.<br /><br />- An attacker can change the environment in which the library loads: the attacker implicitly controls what the library name means.<br /><br />In this case we are primarily concerned with the first scenario, the possibility that an attacker may be able to control the name of the library that is loaded. Process control vulnerabilities of this type occur when:<br /><br />1. Data enters the application from an untrusted source.<br /><p><br />In this case the data enters at <Replace key="SourceFunction" link="SourceLocation"/> in <Replace key="SourceLocation.file"/> at line <Replace key="SourceLocation.line"/>.<br /></p><br />2. The data is used as part of a string representing a library name that is loaded by the application. <br /><p><br />In this case the library is loaded by <Replace key="SinkFunction" link="SinkLocation"/> in <Replace key="SinkLocation.file"/> at line <Replace key="SinkLocation.line"/>.<br /></p><br />3. By executing code from the library, the application gives the attacker a privilege or capability that the attacker would not otherwise have. <br /> <br /><b>Example 1:</b> The following code from a privileged application uses a registry entry to determine the directory in which it is installed and loads a library file based on a relative path from the specified directory. <br /><br /><pre><br />	...<br />	RegQueryValueEx(hkey, "APPHOME",<br />                      0, 0, (BYTE*)home, &amp;size);	<br />	char* lib=(char*)malloc(strlen(home)+strlen(INITLIB));<br />	if (lib) { <br />		strcpy(lib,home);<br />		strcat(lib,INITCMD);<br />		LoadLibrary(lib);<br />	}<br />	...<br /></pre><br /><br />The code in this example allows an attacker to load an arbitrary library, from which code will be executed with the elevated privilege of the application, by modifying a registry key to specify a different path containing a malicious version of <code>INITLIB</code>. Because the program does not validate the value read from the environment, if an attacker can control the value of <code>APPHOME</code>, they can fool the application into running malicious code.<br /><br /><b>Example 2:</b> The following code is from a web-based administration utility that allows users access to an interface through which they can update their profile on the system. The utility uses a library named <code>liberty.dll</code>, which is intended to be found in a standard system directory.<br /><br /><pre><br />LoadLibrary("liberty.dll");<br /></pre><br /><br />However, the program does not specify an absolute path for <code>liberty.dll</code>. If an attacker places a malicious library named <code>liberty.dll</code> higher in the search order than the intended file and has a way to execute the program in their environment rather than the web server's environment, then the application will load the malicious library instead of the trusted one. Because this type of application runs with elevated privileges, the contents of the attacker's <code>liberty.dll</code> is now be run with elevated privileges, potentially giving them complete control of the system.<br /><br />This type of attack is possible due to the search order used by <code>LoadLibrary()</code> when an absolute path is not specified. If the current directory is searched before system directories, as was the case up until the most recent versions of Windows, then this type of attack becomes trivial if the attacker can execute the program locally. The search order is operating system version dependent, and is controlled on newer operating systems by the value of this registry key:<br /><br /><pre><br />HKLM\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode<br /></pre><br /><br />This key is not defined on Windows 2000/NT and Windows Me/98/95 systems. <br /><br />On systems where the key does exist, <code>LoadLibrary()</code> behaves as follows:<br />If <code>SafeDllSearchMode</code> is 1, the search order is as follows:<br />(Default setting for Windows XP-SP1 and later, as well as Windows Server 2003.)<br />1. The directory from which the application was loaded.<br />2. The system directory.<br />3. The 16-bit system directory, if it exists. <br />4. The Windows directory. <br />5. <b>The current directory.</b> <br />6. The directories that are listed in the <code>PATH</code> environment variable.<br />If <code>SafeDllSearchMode</code> is 0, the search order is as follows: <br />1. The directory from which the application was loaded.<br />2. <b>The current directory.</b> <br />3. The system directory.<br />4. The 16-bit system directory, if it exists. <br />5. The Windows directory. <br />6. The directories that are listed in the <code>PATH</code> environment variable.
</p>
<h2>REFERENCES</h2>
<p>
  
</p>